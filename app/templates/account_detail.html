{% extends "base.html" %}
{% block title %}iCloud Backup – Account Konfiguration{% endblock %}

{% block content %}
<div x-data="accountConfig('{{ apple_id }}')" x-init="init()">

    <!-- Header -->
    <div class="d-flex align-items-center gap-3 mb-4">
        <a href="/" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div>
            <h1 class="h3 mb-0" x-text="account.apple_id || 'Lade...'"></h1>
            <span class="badge mt-1"
                  :class="account.status === 'authenticated' ? 'bg-success' : 'bg-warning'"
                  x-text="account.status === 'authenticated' ? 'Verbunden' : account.status">
            </span>
        </div>
    </div>

    <!-- Alert messages -->
    <div class="alert alert-success alert-dismissible" x-show="successMsg" x-transition>
        <span x-text="successMsg"></span>
        <button type="button" class="btn-close" @click="successMsg = ''"></button>
    </div>
    <div class="alert alert-danger alert-dismissible" x-show="errorMsg" x-transition>
        <span x-text="errorMsg"></span>
        <button type="button" class="btn-close" @click="errorMsg = ''"></button>
    </div>

    <form @submit.prevent="saveConfig()">
        <div class="row g-4">

            <!-- Left column: Backup selection -->
            <div class="col-lg-8">

                <!-- What to backup -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Was soll gesichert werden?</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="backupDrive"
                                   x-model="config.backup_drive">
                            <label class="form-check-label" for="backupDrive">
                                <i class="bi bi-folder me-1"></i> iCloud Drive
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="backupPhotos"
                                   x-model="config.backup_photos">
                            <label class="form-check-label" for="backupPhotos">
                                <i class="bi bi-image me-1"></i> iCloud Fotos
                            </label>
                        </div>
                    </div>
                </div>

                <!-- iCloud Drive Configuration -->
                <div class="card mb-4" x-show="config.backup_drive" x-transition>
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-folder me-1"></i> iCloud Drive Konfiguration
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn"
                                    :class="config.drive_config_mode === 'simple' ? 'btn-primary' : 'btn-outline-primary'"
                                    @click="config.drive_config_mode = 'simple'">
                                Einfach
                            </button>
                            <button type="button" class="btn"
                                    :class="config.drive_config_mode === 'advanced' ? 'btn-primary' : 'btn-outline-primary'"
                                    @click="config.drive_config_mode = 'advanced'">
                                Erweitert
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Simple mode: checkboxes -->
                        <div x-show="config.drive_config_mode === 'simple'">
                            <p class="text-muted small mb-3">
                                Wählen Sie die Ordner aus, die gesichert werden sollen:
                            </p>
                            <div x-show="driveFoldersLoading" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm"></div>
                                <span class="ms-2">Ordner werden geladen...</span>
                            </div>
                            <div x-show="!driveFoldersLoading">
                                <div class="form-check mb-3 border-bottom pb-2">
                                    <input class="form-check-input" type="checkbox"
                                           id="folder-all"
                                           :checked="selectAllDrive"
                                           @change="toggleSelectAll()">
                                    <label class="form-check-label fw-bold" for="folder-all">
                                        <i class="bi bi-cloud-fill me-1 text-primary"></i>
                                        Alle Ordner sichern
                                    </label>
                                    <div class="form-text">
                                        Sichert das gesamte iCloud Drive, einschließlich zukünftiger Ordner.
                                    </div>
                                </div>
                                <template x-for="folder in driveFolders" :key="folder.name">
                                    <div class="form-check mb-2" :class="{ 'opacity-50': selectAllDrive }">
                                        <input class="form-check-input" type="checkbox"
                                               :id="'folder-' + folder.name"
                                               :value="folder.name"
                                               :checked="selectAllDrive || selectedFolders.includes(folder.name)"
                                               :disabled="selectAllDrive"
                                               @change="toggleFolder(folder.name)">
                                        <label class="form-check-label" :for="'folder-' + folder.name">
                                            <i class="bi me-1"
                                               :class="folder.type === 'folder' ? 'bi-folder-fill text-warning' : 'bi-file-earmark'"></i>
                                            <span x-text="folder.name"></span>
                                        </label>
                                    </div>
                                </template>
                                <div x-show="driveFolders.length === 0 && !driveFoldersLoading"
                                     class="text-muted small">
                                    Keine Ordner gefunden. Stellen Sie sicher, dass der Account verbunden ist.
                                </div>
                            </div>
                        </div>

                        <!-- Advanced mode: text fields -->
                        <div x-show="config.drive_config_mode === 'advanced'">
                            <p class="text-muted small mb-3">
                                Geben Sie die Pfade ein, die gesichert werden sollen (ein Pfad pro Zeile):
                            </p>
                            <textarea class="form-control font-monospace" rows="8"
                                      x-model="config.drive_folders_advanced"
                                      placeholder="Documents&#10;Desktop&#10;Projects/MyProject"></textarea>
                            <div class="form-text">
                                Relative Pfade ab dem iCloud Drive Root-Verzeichnis.
                            </div>
                        </div>

                        <!-- Drive Sync Policy -->
                        <div class="mt-3 pt-3 border-top">
                            <label for="driveSyncPolicy" class="form-label fw-semibold">
                                <i class="bi bi-arrow-repeat me-1"></i>
                                Remote gelöschte Dateien
                            </label>
                            <select class="form-select" id="driveSyncPolicy"
                                    x-model="config.drive_sync_policy">
                                <option value="delete">Lokal löschen</option>
                                <option value="keep">Lokal behalten</option>
                                <option value="archive">In Archiv verschieben</option>
                            </select>
                            <div class="form-text">
                                Was passiert mit lokalen Dateien, die in iCloud Drive gelöscht wurden?
                                <span x-show="config.drive_sync_policy === 'archive'" class="text-info">
                                    Dateien werden nach <code>/archive/</code> verschoben.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- iCloud Photos Configuration -->
                <div class="card mb-4" x-show="config.backup_photos" x-transition>
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-image me-1"></i> iCloud Fotos Konfiguration
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Shared / Family Library -->
                        <template x-if="sharedLibrary">
                            <div class="mb-3">
                                <template x-if="!sharedLibrary.claimed_by">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="includeFamily"
                                               x-model="config.photos_include_family"
                                               @change="if (config.photos_include_family) { config.shared_library_id = sharedLibrary.id } else { config.shared_library_id = null }">
                                        <label class="form-check-label" for="includeFamily">
                                            <i class="bi bi-people me-1"></i>
                                            Geteilte Mediathek mitsichern
                                        </label>
                                        <div class="form-text">
                                            Geteilte iCloud-Fotomediathek
                                            (<code class="small" x-text="sharedLibrary.id"></code>)
                                        </div>
                                    </div>
                                </template>
                                <template x-if="sharedLibrary.claimed_by">
                                    <div class="d-flex align-items-start gap-2 p-2 rounded border border-info bg-info bg-opacity-10">
                                        <i class="bi bi-info-circle text-info mt-1"></i>
                                        <div class="small">
                                            <strong>Geteilte Mediathek wird bereits gesichert</strong><br>
                                            Die geteilte Mediathek wird bereits über den Account
                                            <strong x-text="sharedLibrary.claimed_by"></strong> gesichert.
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!sharedLibrary && photoLibrariesLoaded">
                            <div class="small text-body-secondary mb-3">
                                <i class="bi bi-info-circle me-1"></i>
                                Keine geteilte Mediathek gefunden.
                            </div>
                        </template>

                        <!-- Photos Sync Policy -->
                        <div class="mt-3 pt-3 border-top">
                            <label for="photosSyncPolicy" class="form-label fw-semibold">
                                <i class="bi bi-arrow-repeat me-1"></i>
                                Remote gelöschte Fotos
                            </label>
                            <select class="form-select" id="photosSyncPolicy"
                                    x-model="config.photos_sync_policy">
                                <option value="keep">Lokal behalten</option>
                                <option value="delete">Lokal löschen</option>
                                <option value="archive">In Archiv verschieben</option>
                            </select>
                            <div class="form-text">
                                Was passiert mit lokalen Fotos, die aus der iCloud Mediathek gelöscht wurden?
                                <span x-show="config.photos_sync_policy === 'archive'" class="text-info">
                                    Fotos werden nach <code>/archive/</code> verschoben.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exclusions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-funnel me-1"></i> Ausschlüsse (Exclusions)
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            Dateien und Ordner, die vom Backup ausgeschlossen werden sollen
                            (ein Muster pro Zeile):
                        </p>
                        <textarea class="form-control font-monospace" rows="5"
                                  x-model="exclusionsText"
                                  placeholder=".DS_Store&#10;*.tmp&#10;.git&#10;node_modules&#10;__pycache__"></textarea>
                        <div class="form-text">
                            Unterstützt Glob-Muster (<code>*.tmp</code>, <code>.git</code>)
                            und relative Pfade (<code>Documents/Temp</code>).
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right column: Settings & Status -->
            <div class="col-lg-4">

                <!-- Destination -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Zielverzeichnis</h5>
                    </div>
                    <div class="card-body">
                        <input type="text" class="form-control font-monospace"
                               x-model="config.destination"
                               placeholder="Wird automatisch generiert">
                        <div class="form-text">
                            Relativ zum Backup-Verzeichnis (<code>/backups/</code>).
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card mb-4">
                    <div class="card-body d-grid gap-2">
                        <button type="submit" class="btn btn-primary" :disabled="saving">
                            <span x-show="saving" class="spinner-border spinner-border-sm me-1"></span>
                            <i class="bi bi-check-lg me-1" x-show="!saving"></i>
                            Konfiguration speichern
                        </button>
                        <button type="button" class="btn btn-success" @click="triggerBackup()"
                                :disabled="backupRunning"
                                x-show="!backupRunning">
                            <i class="bi bi-play-fill me-1"></i>
                            Backup jetzt starten
                        </button>
                        <button type="button" class="btn btn-danger" @click="cancelBackup()"
                                :disabled="cancelRequested"
                                x-show="backupRunning">
                            <i class="bi bi-x-circle me-1" x-show="!cancelRequested"></i>
                            <span x-show="cancelRequested" class="spinner-border spinner-border-sm me-1"></span>
                            <span x-text="cancelRequested ? 'Wird abgebrochen...' : 'Backup abbrechen'"></span>
                        </button>
                    </div>
                </div>

                <!-- Live Progress (visible while backup is running) -->
                <div class="card mb-4" x-show="progress.running" x-transition>
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            Backup läuft...
                        </h5>
                    </div>
                    <div class="card-body small">
                        <div class="mb-2">
                            <strong>Phase:</strong>
                            <span x-text="progressPhaseLabel(progress.phase)"></span>
                        </div>
                        <div class="mb-2" x-show="progress.folder">
                            <strong>Ordner:</strong>
                            <span x-text="progress.folder"></span>
                        </div>
                        <div class="mb-2" x-show="progress.current_file">
                            <strong>Datei:</strong>
                            <span class="font-monospace" x-text="progress.current_file"
                                  style="word-break: break-all"></span>
                        </div>
                        <div class="d-flex flex-wrap gap-3 mt-3">
                            <div>
                                <span class="text-success" x-text="progress.downloaded || 0"></span>
                                <span class="text-body-secondary">heruntergeladen</span>
                            </div>
                            <div>
                                <span class="text-body-secondary" x-text="progress.skipped || 0"></span>
                                <span class="text-body-secondary">übersprungen</span>
                            </div>
                            <div>
                                <span class="text-danger" x-text="progress.errors || 0"></span>
                                <span class="text-body-secondary">Fehler</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Status -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Backup Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="badge"
                                  :class="backupStatusBadge(backupStatus.status)"
                                  x-text="backupStatusLabel(backupStatus.status)">
                            </span>
                        </div>
                        <p class="small text-body-secondary mb-1" x-show="backupStatus.last_backup_at">
                            Letztes Backup: <span x-text="formatDate(backupStatus.last_backup_at)"></span>
                        </p>
                        <p class="small mb-0" x-show="backupStatus.message" x-text="backupStatus.message"></p>

                        <!-- Stats -->
                        <div x-show="backupStatus.stats" class="mt-2 small">
                            <template x-if="backupStatus.stats?.drive">
                                <div class="border-top pt-2 mt-2">
                                    <strong>Drive:</strong>
                                    <div class="d-flex flex-wrap gap-3 mt-1">
                                        <div>
                                            <span class="text-success" x-text="backupStatus.stats.drive.downloaded"></span>
                                            <span class="text-body-secondary">heruntergeladen</span>
                                        </div>
                                        <template x-if="backupStatus.stats.drive.deleted">
                                            <div>
                                                <span class="text-warning" x-text="backupStatus.stats.drive.deleted"></span>
                                                <span class="text-body-secondary">gelöscht</span>
                                            </div>
                                        </template>
                                        <template x-if="backupStatus.stats.drive.archived">
                                            <div>
                                                <span class="text-info" x-text="backupStatus.stats.drive.archived"></span>
                                                <span class="text-body-secondary">archiviert</span>
                                            </div>
                                        </template>
                                        <div>
                                            <span class="text-body-secondary" x-text="backupStatus.stats.drive.skipped"></span>
                                            <span class="text-body-secondary">übersprungen</span>
                                        </div>
                                        <div>
                                            <span class="text-danger" x-text="backupStatus.stats.drive.errors"></span>
                                            <span class="text-body-secondary">Fehler</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <template x-if="backupStatus.stats?.photos">
                                <div class="border-top pt-2 mt-2">
                                    <strong>Fotos:</strong>
                                    <div class="d-flex flex-wrap gap-3 mt-1">
                                        <div>
                                            <span class="text-success" x-text="backupStatus.stats.photos.downloaded"></span>
                                            <span class="text-body-secondary">heruntergeladen</span>
                                        </div>
                                        <template x-if="backupStatus.stats.photos.deleted">
                                            <div>
                                                <span class="text-warning" x-text="backupStatus.stats.photos.deleted"></span>
                                                <span class="text-body-secondary">gelöscht</span>
                                            </div>
                                        </template>
                                        <template x-if="backupStatus.stats.photos.archived">
                                            <div>
                                                <span class="text-info" x-text="backupStatus.stats.photos.archived"></span>
                                                <span class="text-body-secondary">archiviert</span>
                                            </div>
                                        </template>
                                        <div>
                                            <span class="text-body-secondary" x-text="backupStatus.stats.photos.skipped"></span>
                                            <span class="text-body-secondary">übersprungen</span>
                                        </div>
                                        <div>
                                            <span class="text-danger" x-text="backupStatus.stats.photos.errors"></span>
                                            <span class="text-body-secondary">Fehler</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function accountConfig(appleId) {
    return {
        appleId: appleId,
        account: {},
        config: {
            backup_drive: false,
            backup_photos: false,
            drive_config_mode: 'simple',
            drive_folders_simple: [],
            drive_folders_advanced: '',
            photos_include_family: false,
            shared_library_id: null,
            drive_sync_policy: 'delete',
            photos_sync_policy: 'keep',
            destination: '',
        },
        exclusionsText: '',
        selectedFolders: [],
        selectAllDrive: false,
        driveFolders: [],
        driveFoldersLoading: false,
        photoLibraries: [],
        photoLibrariesLoaded: false,
        sharedLibrary: null,
        saving: false,
        backupRunning: false,
        cancelRequested: false,
        backupStatus: {},
        progress: { running: false },
        successMsg: '',
        errorMsg: '',
        statusInterval: null,
        progressInterval: null,

        async init() {
            await Promise.all([
                this.loadAccount(),
                this.loadConfig(),
                this.loadBackupStatus(),
            ]);
            if (this.account.status === 'authenticated') {
                await Promise.all([
                    this.loadDriveFolders(),
                    this.loadPhotoLibraries(),
                ]);
            }
            // Poll backup status every 10 seconds
            this.statusInterval = setInterval(() => this.loadBackupStatus(), 10000);
        },

        destroy() {
            if (this.statusInterval) clearInterval(this.statusInterval);
            if (this.progressInterval) clearInterval(this.progressInterval);
        },

        encodedId() {
            return encodeURIComponent(this.appleId);
        },

        async loadAccount() {
            try {
                const res = await fetch('/api/accounts');
                const accounts = await res.json();
                this.account = accounts.find(a => a.apple_id === this.appleId) || {};
            } catch (e) {
                console.error(e);
            }
        },

        async loadConfig() {
            try {
                const res = await fetch(`/api/backup/configs/${this.encodedId()}`);
                if (!res.ok) return;
                const c = await res.json();
                this.config = {
                    backup_drive: c.backup_drive,
                    backup_photos: c.backup_photos,
                    drive_config_mode: c.drive_config_mode,
                    drive_folders_simple: c.drive_folders_simple || [],
                    drive_folders_advanced: c.drive_folders_advanced || '',
                    photos_include_family: c.photos_include_family,
                    shared_library_id: c.shared_library_id || null,
                    drive_sync_policy: c.drive_sync_policy || 'delete',
                    photos_sync_policy: c.photos_sync_policy || 'keep',
                    destination: c.destination || '',
                };
                const simpleFolders = c.drive_folders_simple || [];
                this.selectAllDrive = simpleFolders.includes('__ALL__');
                this.selectedFolders = this.selectAllDrive ? [] : [...simpleFolders];
                this.exclusionsText = (c.exclusions || []).join('\n');
            } catch (e) {
                console.error(e);
            }
        },

        async loadDriveFolders() {
            this.driveFoldersLoading = true;
            try {
                const res = await fetch(`/api/accounts/${this.encodedId()}/drive-folders`);
                this.driveFolders = await res.json();
            } catch (e) {
                console.error(e);
            }
            this.driveFoldersLoading = false;
        },

        async loadPhotoLibraries() {
            try {
                const res = await fetch(`/api/accounts/${this.encodedId()}/photo-libraries`);
                if (!res.ok) return;
                this.photoLibraries = await res.json();
                this.sharedLibrary = this.photoLibraries.find(l => l.type === 'shared') || null;
                // If the saved shared_library_id no longer exists, reset
                if (this.config.shared_library_id && this.sharedLibrary
                    && this.config.shared_library_id !== this.sharedLibrary.id) {
                    this.config.shared_library_id = null;
                    this.config.photos_include_family = false;
                }
                // If shared library is claimed by another account, reset local config
                if (this.sharedLibrary?.claimed_by) {
                    this.config.photos_include_family = false;
                    this.config.shared_library_id = null;
                }
            } catch (e) {
                console.error(e);
            }
            this.photoLibrariesLoaded = true;
        },

        async loadBackupStatus() {
            try {
                const res = await fetch(`/api/backup/status/${this.encodedId()}`);
                this.backupStatus = await res.json();
                if (this.backupStatus.status === 'running') {
                    this.backupRunning = true;
                    this.startProgressPolling();
                } else {
                    this.backupRunning = false;
                    this.cancelRequested = false;
                    this.stopProgressPolling();
                }
            } catch (e) {
                console.error(e);
            }
        },

        startProgressPolling() {
            if (this.progressInterval) return;
            this.progressInterval = setInterval(() => this.pollProgress(), 2000);
            this.pollProgress();
        },

        stopProgressPolling() {
            if (this.progressInterval) {
                clearInterval(this.progressInterval);
                this.progressInterval = null;
            }
            this.progress = { running: false };
        },

        async pollProgress() {
            try {
                const res = await fetch(`/api/backup/progress/${this.encodedId()}`);
                this.progress = await res.json();
                if (!this.progress.running) {
                    this.stopProgressPolling();
                    await this.loadBackupStatus();
                }
            } catch (e) {
                console.error(e);
            }
        },

        progressPhaseLabel(phase) {
            return {
                'starting': 'Starte...',
                'drive': 'iCloud Drive',
                'photos': 'iCloud Fotos',
            }[phase] || phase || '';
        },

        toggleSelectAll() {
            this.selectAllDrive = !this.selectAllDrive;
        },

        toggleFolder(name) {
            const idx = this.selectedFolders.indexOf(name);
            if (idx >= 0) {
                this.selectedFolders.splice(idx, 1);
            } else {
                this.selectedFolders.push(name);
            }
        },

        async saveConfig() {
            this.saving = true;
            this.successMsg = '';
            this.errorMsg = '';

            const exclusions = this.exclusionsText
                .split('\n')
                .map(l => l.trim())
                .filter(l => l.length > 0);

            const payload = {
                ...this.config,
                drive_folders_simple: this.selectAllDrive ? ['__ALL__'] : this.selectedFolders,
                exclusions: exclusions,
            };

            try {
                const res = await fetch(`/api/backup/configs/${this.encodedId()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (res.ok) {
                    this.successMsg = 'Konfiguration gespeichert.';
                } else {
                    const err = await res.json();
                    this.errorMsg = err.detail || 'Fehler beim Speichern.';
                }
            } catch (e) {
                this.errorMsg = 'Netzwerkfehler: ' + e.message;
            }
            this.saving = false;
        },

        async triggerBackup() {
            this.backupRunning = true;
            this.successMsg = '';
            this.errorMsg = '';
            try {
                const res = await fetch(`/api/backup/run/${this.encodedId()}`, { method: 'POST' });
                if (res.ok) {
                    this.successMsg = 'Backup wurde gestartet.';
                    this.startProgressPolling();
                } else {
                    const err = await res.json();
                    this.errorMsg = err.detail || 'Fehler beim Starten.';
                    this.backupRunning = false;
                }
            } catch (e) {
                this.errorMsg = 'Netzwerkfehler: ' + e.message;
                this.backupRunning = false;
            }
        },

        async cancelBackup() {
            this.cancelRequested = true;
            this.errorMsg = '';
            try {
                const res = await fetch(`/api/backup/cancel/${this.encodedId()}`, { method: 'POST' });
                if (res.ok) {
                    this.successMsg = 'Abbruch angefordert...';
                } else {
                    const err = await res.json();
                    this.errorMsg = err.detail || 'Fehler beim Abbrechen.';
                    this.cancelRequested = false;
                }
            } catch (e) {
                this.errorMsg = 'Netzwerkfehler: ' + e.message;
                this.cancelRequested = false;
            }
        },

        backupStatusBadge(status) {
            return {
                'idle': 'bg-secondary',
                'running': 'bg-info',
                'success': 'bg-success',
                'error': 'bg-danger',
                'not_configured': 'bg-secondary',
            }[status] || 'bg-secondary';
        },

        backupStatusLabel(status) {
            return {
                'idle': 'Bereit',
                'running': 'Läuft...',
                'success': 'Erfolgreich',
                'error': 'Fehler',
                'not_configured': 'Nicht konfiguriert',
            }[status] || status;
        },

        formatDate(iso) {
            if (!iso) return '';
            return new Date(iso).toLocaleString('de-DE');
        },
    };
}
</script>
{% endblock %}
