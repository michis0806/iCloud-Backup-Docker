{% extends "base.html" %}
{% block title %}iCloud Backup – Dashboard{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="init()">

    <!-- Global Schedule Card -->
    <div class="card mb-4">
        <div class="card-body d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-clock fs-5"></i>
                <strong>Zeitplan</strong>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="globalScheduleEnabled"
                       x-model="schedule.enabled" @change="saveSchedule()">
                <label class="form-check-label" for="globalScheduleEnabled">
                    Automatisches Backup
                </label>
            </div>
            <div class="d-flex align-items-center gap-2" x-show="schedule.enabled" x-transition>
                <label class="form-label mb-0 small text-nowrap">Cron:</label>
                <input type="text" class="form-control form-control-sm font-monospace" style="width: 10rem"
                       x-model="schedule.cron" @change="saveSchedule()"
                       placeholder="0 2 * * *">
            </div>
            <div class="text-muted small" x-show="schedule.enabled" x-transition>
                Sichert alle konfigurierten Accounts nacheinander.
            </div>
            <div x-show="scheduleSaved" x-transition class="text-success small">
                <i class="bi bi-check-lg"></i> Gespeichert
            </div>
            <div class="ms-auto">
                <button class="btn btn-outline-success btn-sm"
                        :disabled="runAllLoading"
                        @click="runAllBackups()"
                        title="Alle Backups jetzt starten">
                    <span x-show="runAllLoading" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-play-fill me-1" x-show="!runAllLoading"></i>
                    <span x-show="!runAllLoading">Alle starten</span>
                    <span x-show="runAllLoading">Wird gestartet...</span>
                </button>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Accounts</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
            <i class="bi bi-plus-lg me-1"></i> Account hinzufügen
        </button>
    </div>

    <!-- Accounts list -->
    <div class="row g-3">
        <template x-for="account in accounts" :key="account.apple_id">
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0" x-text="account.apple_id"></h5>
                            <span class="badge"
                                  :class="statusBadge(account.status)"
                                  x-text="statusLabel(account.status)">
                            </span>
                        </div>
                        <p class="card-text text-muted small" x-text="account.status_message"></p>

                        <!-- Storage stats -->
                        <template x-if="storageStats[account.apple_id]">
                            <div class="mb-2">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="rounded p-2 text-center stat-box">
                                            <div class="text-body-secondary small"><i class="bi bi-image me-1"></i>Fotos</div>
                                            <div class="fw-semibold" x-text="storageStats[account.apple_id].photos.count.toLocaleString('de-DE') + ' Objekte'"></div>
                                            <div class="text-body-secondary small" x-text="formatSize(storageStats[account.apple_id].photos.size_bytes)"></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="rounded p-2 text-center stat-box">
                                            <div class="text-body-secondary small"><i class="bi bi-cloud me-1"></i>Drive</div>
                                            <div class="fw-semibold" x-text="storageStats[account.apple_id].drive.count.toLocaleString('de-DE') + ' Dateien'"></div>
                                            <div class="text-body-secondary small" x-text="formatSize(storageStats[account.apple_id].drive.size_bytes)"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div class="d-flex gap-2 mt-3">
                            <!-- 2FA button -->
                            <template x-if="account.status === 'requires_2fa'">
                                <button class="btn btn-warning btn-sm"
                                        @click="show2FA(account)">
                                    <i class="bi bi-shield-lock me-1"></i> 2FA eingeben
                                </button>
                            </template>

                            <!-- Configure button -->
                            <template x-if="account.status === 'authenticated'">
                                <a :href="'/accounts/' + encodeURIComponent(account.apple_id)"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-gear me-1"></i> Konfigurieren
                                </a>
                            </template>

                            <!-- Reconnect button (uses saved session tokens, triggers 2FA if needed) -->
                            <template x-if="account.status === 'error'">
                                <button class="btn btn-outline-warning btn-sm"
                                        @click="reconnect(account)">
                                    <i class="bi bi-arrow-repeat me-1"></i> Erneut verbinden
                                </button>
                            </template>

                            <div class="ms-auto d-flex gap-2">
                                <!-- Run backup button -->
                                <template x-if="account.status === 'authenticated'">
                                    <button class="btn btn-outline-success btn-sm"
                                            :disabled="runningBackups[account.apple_id]"
                                            @click="runBackup(account.apple_id)"
                                            :title="runningBackups[account.apple_id] ? 'Backup läuft...' : 'Backup starten'">
                                        <span x-show="runningBackups[account.apple_id]"
                                              class="spinner-border spinner-border-sm"></span>
                                        <i class="bi bi-play-fill" x-show="!runningBackups[account.apple_id]"></i>
                                    </button>
                                </template>

                                <!-- Delete button -->
                                <button class="btn btn-outline-danger btn-sm"
                                        @click="deleteAccount(account.apple_id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Empty state -->
        <template x-if="accounts.length === 0 && !loading">
            <div class="col-12">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-cloud-slash fs-1 d-block mb-3"></i>
                    <p>Noch keine Accounts vorhanden.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i class="bi bi-plus-lg me-1"></i> Ersten Account hinzufügen
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Add Account Modal -->
    <div class="modal fade" id="addAccountModal" tabindex="-1" x-ref="addModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">iCloud Account hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" x-show="addError" x-text="addError"></div>
                    <form @submit.prevent="addAccount()">
                        <div class="mb-3">
                            <label class="form-label">Apple-ID (E-Mail)</label>
                            <input type="email" class="form-control" x-model="newAppleId"
                                   placeholder="name@icloud.com" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Passwort</label>
                            <input type="password" class="form-control" x-model="newPassword"
                                   placeholder="App-spezifisches Passwort empfohlen" required>
                            <div class="form-text">
                                Das Passwort wird nur zur Erstanmeldung verwendet und
                                <strong>nicht gespeichert</strong>. Wir empfehlen ein
                                <a href="https://support.apple.com/de-de/102654" target="_blank">
                                    app-spezifisches Passwort</a>.
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" :disabled="addLoading">
                            <span x-show="addLoading" class="spinner-border spinner-border-sm me-1"></span>
                            Anmelden
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 2FA Modal -->
    <div class="modal fade" id="tfaModal" tabindex="-1" x-ref="tfaModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Zwei-Faktor-Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" x-show="tfaError" x-text="tfaError"></div>
                    <div class="alert alert-success" x-show="tfaSmsSuccess" x-text="tfaSmsSuccess"></div>

                    <!-- Tab navigation: Device / SMS -->
                    <ul class="nav nav-pills nav-fill mb-3">
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: tfaMode === 'device' }"
                               href="#" @click.prevent="tfaMode = 'device'">
                                <i class="bi bi-phone me-1"></i> Geräte-Code
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: tfaMode === 'sms' }"
                               href="#" @click.prevent="switchToSms()">
                                <i class="bi bi-chat-dots me-1"></i> SMS-Code
                            </a>
                        </li>
                    </ul>

                    <!-- Device code tab -->
                    <div x-show="tfaMode === 'device'">
                        <p class="text-muted small">
                            Geben Sie den 6-stelligen Code von Ihrem Apple-Gerät ein.
                        </p>
                        <form @submit.prevent="submit2FA()">
                            <div class="mb-3">
                                <input type="text" class="form-control form-control-lg text-center"
                                       x-model="tfaCode" maxlength="6" pattern="[0-9]{6}"
                                       placeholder="000000" autofocus>
                            </div>
                            <button type="submit" class="btn btn-warning w-100" :disabled="tfaLoading">
                                <span x-show="tfaLoading" class="spinner-border spinner-border-sm me-1"></span>
                                Bestätigen
                            </button>
                        </form>
                    </div>

                    <!-- SMS tab -->
                    <div x-show="tfaMode === 'sms'">
                        <!-- Device selection -->
                        <template x-if="!tfaSmsSent">
                            <div>
                                <p class="text-muted small">
                                    Wählen Sie ein Gerät, an das der SMS-Code gesendet werden soll.
                                </p>
                                <div x-show="tfaDevicesLoading" class="text-center py-3">
                                    <span class="spinner-border spinner-border-sm"></span> Geräte werden geladen…
                                </div>
                                <div class="list-group mb-3" x-show="!tfaDevicesLoading && tfaDevices.length > 0">
                                    <template x-for="device in tfaDevices" :key="device.index">
                                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                                @click="sendSmsCode(device.index)"
                                                :disabled="tfaSmsLoading">
                                            <span>
                                                <i class="bi bi-phone me-2"></i>
                                                <span x-text="device.name"></span>
                                            </span>
                                            <span class="text-muted small" x-text="device.phone"></span>
                                        </button>
                                    </template>
                                </div>
                                <div x-show="!tfaDevicesLoading && tfaDevices.length === 0" class="text-muted small">
                                    Keine Geräte für SMS-Verifizierung verfügbar.
                                </div>
                                <div x-show="tfaSmsLoading" class="text-center py-2">
                                    <span class="spinner-border spinner-border-sm"></span> SMS wird gesendet…
                                </div>
                            </div>
                        </template>

                        <!-- Code input after SMS sent -->
                        <template x-if="tfaSmsSent">
                            <div>
                                <p class="text-muted small">
                                    Geben Sie den per SMS empfangenen Code ein.
                                </p>
                                <form @submit.prevent="submit2SA()">
                                    <div class="mb-3">
                                        <input type="text" class="form-control form-control-lg text-center"
                                               x-model="tfaCode" maxlength="6" pattern="[0-9]{6}"
                                               placeholder="000000" autofocus>
                                    </div>
                                    <button type="submit" class="btn btn-warning w-100" :disabled="tfaLoading">
                                        <span x-show="tfaLoading" class="spinner-border spinner-border-sm me-1"></span>
                                        Bestätigen
                                    </button>
                                    <button type="button" class="btn btn-link btn-sm w-100 mt-2"
                                            @click="tfaSmsSent = false; tfaSmsSuccess = ''">
                                        <i class="bi bi-arrow-left me-1"></i> Anderes Gerät wählen
                                    </button>
                                </form>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function dashboard() {
    return {
        accounts: [],
        storageStats: {},
        loading: true,

        // Global schedule
        schedule: { enabled: false, cron: '0 2 * * *' },
        scheduleSaved: false,

        // Backup triggers
        runningBackups: {},
        runAllLoading: false,

        // Add account
        newAppleId: '',
        newPassword: '',
        addLoading: false,
        addError: '',

        // 2FA
        tfaAppleId: null,
        tfaCode: '',
        tfaLoading: false,
        tfaError: '',
        tfaMode: 'device',       // 'device' or 'sms'
        tfaDevices: [],
        tfaDevicesLoading: false,
        tfaSmsLoading: false,
        tfaSmsSent: false,
        tfaSmsDeviceIndex: null,
        tfaSmsSuccess: '',

        async init() {
            await Promise.all([
                this.loadAccounts(),
                this.loadSchedule(),
                this.loadStorageStats(),
            ]);
        },

        async loadSchedule() {
            try {
                const res = await fetch('/api/backup/schedule');
                if (res.ok) {
                    this.schedule = await res.json();
                }
            } catch (e) {
                console.error('Fehler beim Laden des Zeitplans:', e);
            }
        },

        async saveSchedule() {
            this.scheduleSaved = false;
            try {
                const res = await fetch('/api/backup/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.schedule),
                });
                if (res.ok) {
                    this.scheduleSaved = true;
                    setTimeout(() => this.scheduleSaved = false, 3000);
                }
            } catch (e) {
                console.error('Fehler beim Speichern des Zeitplans:', e);
            }
        },

        async loadStorageStats() {
            try {
                const res = await fetch('/api/accounts/storage-stats');
                if (res.ok) {
                    this.storageStats = await res.json();
                }
            } catch (e) {
                console.error('Fehler beim Laden der Speicherstatistiken:', e);
            }
        },

        formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            const val = bytes / Math.pow(1024, i);
            return val.toLocaleString('de-DE', { maximumFractionDigits: 1 }) + ' ' + units[i];
        },

        async loadAccounts() {
            this.loading = true;
            try {
                const res = await fetch('/api/accounts');
                if (!res.ok) {
                    console.error('API-Fehler:', res.status, await res.text());
                    return;
                }
                const data = await res.json();
                this.accounts = Array.isArray(data) ? data : [];
            } catch (e) {
                console.error('Fehler beim Laden der Accounts:', e);
            }
            this.loading = false;
        },

        async addAccount() {
            this.addLoading = true;
            this.addError = '';
            try {
                const res = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apple_id: this.newAppleId,
                        password: this.newPassword,
                    }),
                });
                if (!res.ok) {
                    const err = await res.json();
                    this.addError = err.detail || 'Fehler beim Hinzufügen.';
                    this.addLoading = false;
                    return;
                }
                this.newAppleId = '';
                this.newPassword = '';
                bootstrap.Modal.getInstance(this.$refs.addModal).hide();
                await this.loadAccounts();
            } catch (e) {
                this.addError = 'Netzwerkfehler: ' + e.message;
            }
            this.addLoading = false;
        },

        show2FA(account) {
            this.tfaAppleId = account.apple_id;
            this.tfaCode = '';
            this.tfaError = '';
            this.tfaMode = 'device';
            this.tfaDevices = [];
            this.tfaSmsSent = false;
            this.tfaSmsDeviceIndex = null;
            this.tfaSmsSuccess = '';
            new bootstrap.Modal(this.$refs.tfaModal).show();
        },

        async switchToSms() {
            this.tfaMode = 'sms';
            this.tfaError = '';
            this.tfaSmsSuccess = '';
            this.tfaSmsSent = false;
            if (this.tfaDevices.length === 0) {
                await this.loadTrustedDevices();
            }
        },

        async loadTrustedDevices() {
            this.tfaDevicesLoading = true;
            try {
                const res = await fetch(`/api/accounts/${encodeURIComponent(this.tfaAppleId)}/2fa/devices`);
                if (res.ok) {
                    this.tfaDevices = await res.json();
                }
            } catch (e) {
                this.tfaError = 'Fehler beim Laden der Geräte: ' + e.message;
            }
            this.tfaDevicesLoading = false;
        },

        async sendSmsCode(deviceIndex) {
            this.tfaSmsLoading = true;
            this.tfaError = '';
            this.tfaSmsSuccess = '';
            try {
                const res = await fetch(`/api/accounts/${encodeURIComponent(this.tfaAppleId)}/2fa/sms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_index: deviceIndex }),
                });
                const data = await res.json();
                if (data.success) {
                    this.tfaSmsDeviceIndex = deviceIndex;
                    this.tfaSmsSent = true;
                    this.tfaSmsSuccess = data.message || 'SMS-Code gesendet.';
                } else {
                    this.tfaError = data.message || 'SMS konnte nicht gesendet werden.';
                }
            } catch (e) {
                this.tfaError = 'Netzwerkfehler: ' + e.message;
            }
            this.tfaSmsLoading = false;
        },

        async submit2FA() {
            this.tfaLoading = true;
            this.tfaError = '';
            try {
                const res = await fetch(`/api/accounts/${encodeURIComponent(this.tfaAppleId)}/2fa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: this.tfaCode }),
                });
                const data = await res.json();
                if (data.status === 'authenticated') {
                    bootstrap.Modal.getInstance(this.$refs.tfaModal).hide();
                    await this.loadAccounts();
                } else {
                    this.tfaError = data.status_message || 'Code ungültig.';
                }
            } catch (e) {
                this.tfaError = 'Netzwerkfehler: ' + e.message;
            }
            this.tfaLoading = false;
        },

        async submit2SA() {
            this.tfaLoading = true;
            this.tfaError = '';
            this.tfaSmsSuccess = '';
            try {
                const res = await fetch(`/api/accounts/${encodeURIComponent(this.tfaAppleId)}/2sa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_index: this.tfaSmsDeviceIndex,
                        code: this.tfaCode,
                    }),
                });
                const data = await res.json();
                if (data.status === 'authenticated') {
                    bootstrap.Modal.getInstance(this.$refs.tfaModal).hide();
                    await this.loadAccounts();
                } else {
                    this.tfaError = data.status_message || 'Code ungültig.';
                }
            } catch (e) {
                this.tfaError = 'Netzwerkfehler: ' + e.message;
            }
            this.tfaLoading = false;
        },

        async reconnect(account) {
            try {
                const res = await fetch(`/api/accounts/${encodeURIComponent(account.apple_id)}/reconnect`, { method: 'POST' });
                const data = await res.json();
                // If reconnect requires 2FA, show the 2FA dialog
                if (data.status === 'requires_2fa') {
                    this.show2FA(data);
                }
                await this.loadAccounts();
            } catch (e) {
                console.error('Reconnect-Fehler:', e);
            }
        },

        async runBackup(appleId) {
            this.runningBackups[appleId] = true;
            try {
                const res = await fetch(`/api/backup/run/${encodeURIComponent(appleId)}`, { method: 'POST' });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || 'Fehler beim Starten.');
                }
            } catch (e) {
                console.error('Backup-Start-Fehler:', e);
            }
            // Keep spinner for a bit, then poll status
            setTimeout(() => { this.runningBackups[appleId] = false; }, 3000);
        },

        async runAllBackups() {
            this.runAllLoading = true;
            try {
                const res = await fetch('/api/backup/run-all', { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    (data.triggered || []).forEach(id => { this.runningBackups[id] = true; });
                    setTimeout(() => {
                        (data.triggered || []).forEach(id => { this.runningBackups[id] = false; });
                    }, 3000);
                } else {
                    const err = await res.json();
                    alert(err.detail || 'Fehler beim Starten.');
                }
            } catch (e) {
                console.error('Backup-Alle-Fehler:', e);
            }
            this.runAllLoading = false;
        },

        async deleteAccount(appleId) {
            if (!confirm('Account wirklich löschen? Alle zugehörigen Konfigurationen werden ebenfalls entfernt.')) return;
            try {
                await fetch(`/api/accounts/${encodeURIComponent(appleId)}`, { method: 'DELETE' });
                await this.loadAccounts();
            } catch (e) {
                console.error('Lösch-Fehler:', e);
            }
        },

        statusBadge(status) {
            return {
                'authenticated': 'bg-success',
                'requires_2fa': 'bg-warning text-dark',
                'pending': 'bg-secondary',
                'error': 'bg-danger',
            }[status] || 'bg-secondary';
        },

        statusLabel(status) {
            return {
                'authenticated': 'Verbunden',
                'requires_2fa': '2FA erforderlich',
                'pending': 'Ausstehend',
                'error': 'Fehler',
            }[status] || status;
        },
    };
}
</script>
{% endblock %}
